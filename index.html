<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beitrittserklärung KJN</title>
    <link rel="icon" href="https://scontent-fra3-2.xx.fbcdn.net/v/t39.30808-6/326392531_1839055796475810_667497308983715319_n.png?_nc_cat=104&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=7G_9qMTB1mAQ7kNvgGRN6cu&_nc_zt=23&_nc_ht=scontent-fra3-2.xx&_nc_gid=AMDSnmzYKIgqbzUe2EpszIc&oh=00_AYA5Wtm2NQY_4inKYNbiFh-qbowyM0iaFlwN8CutDt8gYA&oe=67209A4B" type="image/x-icon">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            overflow: auto;
            background-color: #f5f5f5;
        }
        .scrollable-text {
            width: 96%;
            max-width: 100%;
            height: 100px;
            margin: 0 auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: none;
            overflow-y: scroll;
            font-size: 10px;
        }
        h1 {
            font-size: 30px;
            margin-bottom: 10px;
            text-align: center;
        }
        form {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        @media (max-width: 768px) {
            form { width: 90%; }
            .signature-container { width: 90%; }
        }
        .form-group { margin-bottom: 15px; width: 100%; max-width: 90%; margin: 0 auto; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: calc(100% - 20px); padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
        .button-containers { display: flex; justify-content: center; align-items: center; margin-bottom:20px; height: 100%; }
        .download-button { display: inline-block; padding: 10px 20px; background-color: #007BFF; color: white; text-decoration: none; border-radius: 5px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background-color 0.3s ease; }
        .download-button:hover { background-color: #0056b3; }
        .button-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .button-container button { margin-top: 20px; padding: 12px 20px; font-size: 16px; border: none; border-radius: 5px; color: white; cursor: pointer; }
        #clear-signature { background-color: red; }
        #download-pdf { background-color: orange; }
        #emailButton { background-color: green; }
        @media (max-width: 768px) {
            .button-container { flex-direction: column; align-items: center; }
        }
        button:hover { background-color: #0056b3; }
        img { display: block; max-width: 30%; height: auto; margin:0 auto 20px auto; border-radius: 20px; border: 3px solid #228B22; transition: transform 0.2s ease; }
        img:hover { transform: scale(1.02); }
        #result { font-weight: bold; color: red; }
        .error-message { color: red; margin-top: 15px; font-weight: bold; margin-bottom:20px; }
    </style>
</head>
<body>
    <form id="membership-form">
        <h1>Beitrittserklärung KJN</h1>
        <a href="https://www.facebook.com/kjneuengruen/?locale=de_DE" target="_blank">
            <img src="https://github.com/kath-jugend-neuengruen/Beitrittserklaerung-KJN/blob/main/470207678_3926429560975333_2043178117568937116_n.jpg?raw=true" alt="Logo">
        </a>

        <h1>Alle Veranstaltungen hier</h1>
        <div class="button-containers">
            <a href="KJNeuengrün_Termine2025.ics" download class="download-button">Veranstaltungskalender</a>
        </div>

        <div class="form-group">
            <textarea class="scrollable-text" readonly>
Hiermit erkläre ich meinen Beitritt zur Kath. Jugend Neuengrün-Schlegelshaid...
            </textarea>

            <label for="vorname">Vorname:</label>
            <input type="text" id="vorname" name="vorname" required>
            <label for="name">Nachname:</label>
            <input type="text" id="name" name="name" required>
            <label for="geburtsdatum">Geburtsdatum:</label>
            <input type="date" id="geburtsdatum" name="geburtsdatum" required>
            <label for="strasse">Straße/Hausnummer:</label>
            <input type="text" id="strasse" name="strasse" required>
            <label for="plz">PLZ/Wohnort:</label>
            <input type="text" id="plz" name="plz" required>
            <label for="telefon">Telefon:</label>
            <input type="text" id="telefon" name="telefon" required>
            <label for="email">E-Mail:</label>
            <input type="email" id="email" name="email" required>
            <label for="kontoinhaber">Kontoinhaber:</label>
            <input type="text" id="kontoinhaber" name="kontoinhaber" required>
            <label for="iban">IBAN:</label>
            <input type="text" id="iban" name="iban" required>
            <div id="result"></div>
            <label for="bic">BIC:</label>
            <input type="text" id="bic" name="bic" required>
            <label for="ort">Aktueller Ort:</label>
            <input type="text" id="ort" name="ort" required>
        </div>

        <div class="form-group">
            <label for="unterschrift">Unterschrift:</label>
            <canvas id="signature-pad" style="width: 100%; border: 1px solid #000;"></canvas>
        </div>

        <div id="error-message" class="error-message"></div>

        <div class="button-container">
            <button type="button" id="clear-signature">Unterschrift löschen</button>
            <button type="button" id="download-pdf">PDF herunterladen</button>
            <button type="button" id="emailButton">KJN E-Mail senden</button>
        </div>

        <h1>Alles Ausfüllen → PDF herunterladen → Email mit PDF versenden</h1>
    </form>

    <script>
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas);

        function areAllFieldsFilled() {
            const requiredFields = document.querySelectorAll('#membership-form [required]');
            return Array.from(requiredFields).every(field => field.value.trim() !== '');
        }

        function showErrorMessage(message) {
            document.getElementById('error-message').textContent = message;
        }

        function hideErrorMessage() {
            document.getElementById('error-message').textContent = '';
        }

        function validateIBAN(iban) {
            iban = iban.toUpperCase().replace(/\s/g, '');
            if (iban.length !== 22) return "Ungültige IBAN-Länge.";
            const rearrangedIban = iban.slice(4) + iban.slice(0, 4);
            const numericIban = rearrangedIban.split('').map(char => /[A-Z]/.test(char) ? char.charCodeAt(0)-55 : char).join('');
            return BigInt(numericIban) % 97n === 1n ? "Die IBAN ist korrekt." : "Die IBAN ist nicht korrekt.";
        }

        // Signatur-Canvas resize
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const ctx = canvas.getContext("2d");
            const savedData = signaturePad.toDataURL();
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.width/2;
            ctx.scale(ratio, ratio);
            if (savedData) {
                const img = new Image();
                img.src = savedData;
                img.onload = () => ctx.drawImage(img, 0, 0, canvas.width/ratio, canvas.height/ratio);
            }
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        document.getElementById('clear-signature').addEventListener('click', () => {
            signaturePad.clear();
        });

        document.getElementById('download-pdf').addEventListener('click', async () => {
            const formData = new FormData(document.getElementById('membership-form'));
            const ibanToCheck = document.getElementById('iban').value;
            const result = validateIBAN(ibanToCheck);
            document.getElementById('result').innerText = result;

            if (!areAllFieldsFilled()) { showErrorMessage('Bitte füllen Sie alle erforderlichen Felder aus.'); return; }
            hideErrorMessage();
            if (result !== "Die IBAN ist korrekt.") return;

            // PDF erstellen
            const { PDFDocument, rgb } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([600,800]);
            const marginLeft = 50;
            const marginTop = 750;
            const textWidth = page.getWidth() - 2*marginLeft;
            let currentY = marginTop;

            const currentDate = new Date();
            const formattedDate = `${currentDate.getDate().toString().padStart(2,'0')}.${(currentDate.getMonth()+1).toString().padStart(2,'0')}.${currentDate.getFullYear()}`;

            page.drawText('Kath. Jugend Neuengrün-Schlegelshaid', { x: page.getWidth()/2-150, y: currentY, size:16, color:rgb(0,0,0), font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold) });
            currentY -= 20;
            page.drawText('Beitrittserklärung', { x: page.getWidth()/2-70, y: currentY, size:14, color:rgb(0,0,0), font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold) });
            currentY -= 20;
            page.drawText('Hiermit erkläre ich meinen Beitritt zur Kath. Jugend Neuengrün-Schlegelshaid...', { x: marginLeft, y: currentY, size:12, color:rgb(0,0,0), maxWidth:textWidth });

            currentY -= 110;
            const fields = [
                { name: 'Vorname', y: currentY, value: formData.get('vorname') },
                { name: 'Name', y: currentY-30, value: formData.get('name') },
                { name: 'Geburtsdatum', y: currentY-60, value: formData.get('geburtsdatum') },
                { name: 'Straße/Haus-Nr', y: currentY-90, value: formData.get('strasse') },
                { name: 'PLZ/Wohnort', y: currentY-120, value: formData.get('plz') },
                { name: 'Telefon', y: currentY, value: formData.get('telefon'), xOffset:255 },
                { name: 'E-Mail', y: currentY-30, value: formData.get('email'), xOffset:255 }
            ];

            for(const f of fields){
                const field = pdfDoc.getForm().createTextField(f.name);
                field.addToPage(page,{x:50+(f.xOffset||0)+95-0, y:f.y, width:140, height:20});
                page.drawText(f.name,{x:50+(f.xOffset||0),y:f.y+5,size:12,color:rgb(0,0,0), font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold)});
                field.setFontSize(12);
                field.setText(f.value);
            }

            // Signatur einfügen
            if(!signaturePad.isEmpty()){
                const signatureImage = signaturePad.toDataURL();
                const binaryString = atob(signatureImage.split(',')[1]);
                const bytes = new Uint8Array(binaryString.length);
                for(let i=0;i<binaryString.length;i++){ bytes[i]=binaryString.charCodeAt(i); }
                const png = await pdfDoc.embedPng(bytes);
                page.drawImage(png,{x:340,y:40,width:250,height:125});
            }

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes],{type:'application/pdf'});
            const url = URL.createObjectURL(blob);

            const vorname = formData.get('vorname')||'Vorname';
            const name = formData.get('name')||'Nachname';
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

            if(isIOS){
                window.location.href = url;
                alert("iPhone erkannt: PDF wird im Browser geöffnet. Bitte oben rechts auf 'Teilen' tippen und 'In Dateien sichern' auswählen, um die PDF herunterzuladen.");
            } else {
                const a = document.createElement('a');
                a.href = url;
                a.download = `Beitrittserklaerung-${vorname}-${name}-${formattedDate.replace(/\./g,'-')}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });

        // Email-Button bleibt unverändert
        document.getElementById('emailButton').addEventListener('click', function(){
            if(!areAllFieldsFilled()){ showErrorMessage('Bitte füllen Sie alle erforderlichen Felder aus.'); return; }
            hideErrorMessage();
            const ibanToCheck = document.getElementById('iban').value;
            if(validateIBAN(ibanToCheck)!=="Die IBAN ist korrekt.") return;

            const vorname = document.getElementById('vorname').value;
            const name = document.getElementById('name').value;
            const email = "christopher@online-jack.de";
            const subject = "Beitrittserklärung";
            const body = `**${vorname}, Bitte vergessen Sie nicht, die automatisch erstellte PDF-Datei beizufügen!**\n\nHallo liebes KJN-Team,\n\nanbei finden Sie meine Beitrittserklärung im PDF-Format.\n\nMit freundlichen Grüßen,\n${vorname} ${name}`;
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        });

    </script>
</body>
</html>
