<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beitrittserkl√§rung KJN</title>
    <link rel="icon" href="https://scontent-fra3-2.xx.fbcdn.net/v/t39.30808-6/326392531_1839055796475810_667497308983715319_n.png?_nc_cat=104&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=7G_9qMTB1mAQ7kNvgGRN6cu&_nc_zt=23&_nc_ht=scontent-fra3-2.xx&_nc_gid=AMDSnmzYKIgqbzUe2EpszIc&oh=00_AYA5Wtm2NQY_4inKYNbiFh-qbowyM0iaFlwN8CutDt8gYA&oe=67209A4B" type="image/x-icon">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f0f2f5; }
        form { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); width: 100%; max-width: 650px; box-sizing: border-box; }
        h1 { color: #1a1a1a; font-size: 22px; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #228B22; padding-bottom: 10px; }
        h2 { font-size: 16px; margin-top: 25px; color: #228B22; border-left: 4px solid #228B22; padding-left: 10px; }
        .info-text { font-size: 12px; line-height: 1.5; color: #444; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 13px; color: #333; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        canvas { width: 100%; height: 180px; border: 2px dashed #999; border-radius: 8px; background: #fff; cursor: crosshair; touch-action: none; }
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 25px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; min-width: 140px; }
        #clear-signature { background: #6c757d; }
        #download-pdf { background: #fd7e14; }
        #emailButton { background: #228B22; }
        .logo { display: block; max-width: 120px; margin: 0 auto 15px; border-radius: 10px; }
        #error-message { color: #dc3545; font-weight: bold; margin-top: 15px; text-align: center; font-size: 14px; }
    </style>
</head>
<body>

    <form id="membership-form">
        <img class="logo" src="https://github.com/kath-jugend-neuengruen/Beitrittserklaerung-KJN/blob/main/470207678_3926429560975333_2043178117568937116_n.jpg?raw=true" alt="KJN Logo">
        <h1>Beitrittserkl√§rung KJN</h1>

        <div class="info-text">
            Hiermit erkl√§re ich meinen Beitritt zur Kath. Jugend Neuengr√ºn-Schlegelshaid und bin gleichzeitig damit einverstanden, dass der Verein meine unten angegebenen Daten, wie z.B. Vor- und Zuname, Geburtstag usw., sowie Ehrungen/Auszeichnungen und Fotografien, ver√∂ffentlichen darf. Dieser Einwilligung kann ich jederzeit widersprechen.
        </div>

        <h2>Pers√∂nliche Daten</h2>
        <div class="form-group"><label>Vorname</label><input type="text" name="vorname" required></div>
        <div class="form-group"><label>Name</label><input type="text" name="name" required></div>
        <div class="form-group"><label>Geburtsdatum</label><input type="date" name="geburtsdatum" required></div>
        <div class="form-group"><label>Stra√üe/Haus-Nr</label><input type="text" name="strasse" required></div>
        <div class="form-group"><label>PLZ/Wohnort</label><input type="text" name="plz" required></div>
        <div class="form-group"><label>Telefon</label><input type="text" name="telefon" required></div>
        <div class="form-group"><label>E-Mail</label><input type="email" name="email" required></div>

        <h2>SEPA-Lastschriftmandat</h2>
        <div class="info-text" style="font-weight: 600;">
            Gl√§ubiger-ID: DE50ZZZ00000431398 <br> 
            Mandatsreferenznummer: Mitgliedsnummer
        </div>
        <div class="info-text">
            Ich erm√§chtige die Kath. Jugend Neuengr√ºn-Schlegelshaid den Jahresbeitrag von momentan 7.-- ‚Ç¨ (F√§lligkeit: jeweils Anfang Januar) von meinem Konto mittels Lastschrift einzuziehen. Zugleich weise ich mein Kreditinstitut an, die von der Kath. Jugend Neuengr√ºn-Schlegelshaid auf mein Konto gezogenen Lastschriften einzul√∂sen.
        </div>
        <div class="form-group"><label>Kontoinhaber</label><input type="text" name="kontoinhaber" required></div>
        <div class="form-group"><label>IBAN</label><input type="text" id="iban" name="iban" required></div>
        <div class="form-group"><label>BIC</label><input type="text" id="bic" name="bic" required></div>
        <div id="iban-check" style="font-size: 11px; margin-top: -10px; margin-bottom: 10px;"></div>
        
        <div class="form-group"><label>Ort der Unterschrift</label><input type="text" name="ort" required placeholder="z.B. Neuengr√ºn"></div>

        <div class="form-group">
            <label>Unterschrift</label>
            <canvas id="signature-pad"></canvas>
        </div>

        <div id="error-message"></div>

        <div class="btn-row">
            <button type="button" id="clear-signature">üóë Leeren</button>
            <button type="button" id="download-pdf">üì• PDF Speichern</button>
            <button type="button" id="emailButton">‚úâÔ∏è Per Mail senden</button>
        </div>

        <div id="choice-modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:10px; text-align:center;">
        <h3>PDF fertig!</h3>
        <button id="modal-download" style="background:black;">üíæ Download</button>
        <button id="modal-share" style="display:none; background: black;">üì§ Teilen</button>
        <button onclick="closeModal(event)" style="background:black;">Abbrechen</button>
    </div>
</div>
    </form>

    <script>
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

        let lastWidth = 0;
function resizeCanvas() {
    // Nur reagieren, wenn sich die Breite tats√§chlich ge√§ndert hat (verhindert L√∂schen beim Scrollen)
    if (canvas.offsetWidth === lastWidth) return;
    
    lastWidth = canvas.offsetWidth;
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    
    // Nur beim ersten Laden oder echter Drehung des Bildschirms leeren
    signaturePad.clear(); 
}
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        function validateIBAN(iban) {
            iban = iban.toUpperCase().replace(/\s/g, '');
            if (iban.length !== 22) return false;
            const rearranged = iban.slice(4) + iban.slice(0, 4);
            const numeric = rearranged.split('').map(c => /[A-Z]/.test(c) ? c.charCodeAt(0)-55 : c).join('');
            return BigInt(numeric) % 97n === 1n;
        }

        document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());

        document.getElementById('download-pdf').addEventListener('click', async () => {
            const form = document.getElementById('membership-form');
            const formData = new FormData(form);
            
            if (!form.checkValidity() || signaturePad.isEmpty()) {
                document.getElementById('error-message').textContent = "Bitte alle Felder ausf√ºllen und unterschreiben!";
                return;
            }
            if (!validateIBAN(formData.get('iban'))) {
                document.getElementById('error-message').textContent = "Die IBAN ist ung√ºltig!";
                return;
            }
            document.getElementById('error-message').textContent = "";

            // PDF Generierung
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([595.28, 841.89]); // A4
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            
            let y = 800;
            const margin = 50;

            // Header
            page.drawText('Kath. Jugend Neuengr√ºn-Schlegelshaid', { x: margin, y: y, size: 16, font: fontBold });
            y -= 20;
            page.drawText('Beitrittserkl√§rung', { x: margin, y: y, size: 14, font: fontBold });
            y -= 35;

            // Einleitungstext
            const introText = "Hiermit erkl√§re ich meinen Beitritt zur Kath. Jugend Neuengr√ºn-Schlegelshaid und bin gleichzeitig damit einverstanden, dass der Verein meine unten angegebenen Daten, wie z.B. Vor- und Zuname, Geburtstag usw., sowie Ehrungen/Auszeichnungen und Fotografien, ver√∂ffentlichen darf. Dieser Einwilligung kann ich jederzeit widersprechen.";
            page.drawText(introText, { x: margin, y: y, size: 10, font: font, maxWidth: 500, lineHeight: 12 });
            y -= 55;

            // Daten Zeichnen Funktion
            const drawField = (label, value) => {
                page.drawText(label + ":", { x: margin, y: y, size: 10, font: fontBold });
                page.drawText(String(value), { x: margin + 120, y: y, size: 10, font: font });
                y -= 18;
            };

            drawField('Vorname', formData.get('vorname'));
            drawField('Name', formData.get('name'));
            drawField('Geburtsdatum', formData.get('geburtsdatum'));
            drawField('Stra√üe/Haus-Nr', formData.get('strasse'));
            drawField('PLZ/Wohnort', formData.get('plz'));
            drawField('Telefon', formData.get('telefon'));
            drawField('E-Mail', formData.get('email'));

            y -= 20;
            page.drawText('SEPA-Lastschriftmandat', { x: margin, y: y, size: 12, font: fontBold, color: rgb(0.13, 0.54, 0.13) });
            y -= 15;
            page.drawText('Gl√§ubiger-ID: DE50ZZZ00000431398     Mandatsreferenz: Mitgliedsnummer', { x: margin, y: y, size: 9, font: fontBold });
            y -= 20;

            const sepaText = "Ich erm√§chtige die Kath. Jugend Neuengr√ºn-Schlegelshaid den Jahresbeitrag von momentan 7.-- ‚Ç¨ (F√§lligkeit: jeweils Anfang Januar) von meinem Konto mittels Lastschrift einzuziehen. Zugleich weise ich mein Kreditinstitut an, die von der Kath. Jugend Neuengr√ºn-Schlegelshaid, auf mein Konto gezogenen Lastschriften einzul√∂sen.";
            page.drawText(sepaText, { x: margin, y: y, size: 9, font: font, maxWidth: 500, lineHeight: 11 });
            y -= 45;

            const hinweisText = "Hinweis: Ich kann innerhalb von acht Wochen, beginnend mit dem Belastungsdatum, die Erstattung des belasteten Betrages verlangen. Es gelten dabei die mit meinem Kreditinstitut vereinbarten Bedingungen.";
            page.drawText(hinweisText, { x: margin, y: y, size: 8, font: font, maxWidth: 500, lineHeight: 10, color: rgb(0.3, 0.3, 0.3) });
            y -= 30;

            drawField('Kontoinhaber', formData.get('kontoinhaber'));
            drawField('IBAN', formData.get('iban'));
            drawField('BIC', formData.get('bic'));

            y -= 40;
            const dateStr = new Date().toLocaleDateString('de-DE');
            page.drawText(`${formData.get('ort')}, den ${dateStr}`, { x: margin, y: y, size: 10, font: font });
            
            // Unterschrift (JPEG Kompression f√ºr geringe Dateigr√∂√üe)
            const sigImg = signaturePad.toDataURL("image/jpeg", 0.7);
            const sigBytes = Uint8Array.from(atob(sigImg.split(',')[1]), c => c.charCodeAt(0));
            const sigImgEmbed = await pdfDoc.embedJpg(sigBytes);
            page.drawImage(sigImgEmbed, { x: margin, y: y - 70, width: 150, height: 60 });
            
            y -= 75;
            page.drawLine({ start: {x: margin, y: y}, end: {x: margin + 180, y: y}, thickness: 1 });
            page.drawText('Unterschrift', { x: margin, y: y - 12, size: 8, font: font });

            const pdfBytes = await pdfDoc.save();
            const file = new File([pdfBytes], `KJN_Beitritt_${formData.get('name')}.pdf`, { type: 'application/pdf' });

            // --- DIESEN TEIL ERSETZEN ---
            const modal = document.getElementById('choice-modal');
            const shareBtn = document.getElementById('modal-share');
            
            // Popup anzeigen
            modal.style.display = 'flex';

            // "Teilen"-Button nur anzeigen, wenn das Ger√§t es technisch kann
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                shareBtn.style.display = 'flex';
            } else {
                shareBtn.style.display = 'none';
            }

            // Funktion f√ºr Download-Button im Popup
            document.getElementById('modal-download').onclick = () => {
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                closeModal();
            };

            // Funktion f√ºr Teilen-Button im Popup
            shareBtn.onclick = async () => {
                try {
                    await navigator.share({ 
                        files: [file], 
                        title: 'Beitrittserkl√§rung KJN' 
                    });
                } catch (err) {
                    console.log("Teilen abgebrochen oder fehlgeschlagen", err);
                }
                closeModal();
            };
            // --- ENDE ERSETZEN ---
        });

        document.getElementById('emailButton').addEventListener('click', () => {
            const formData = new FormData(document.getElementById('membership-form'));
            const mail = "christopher@online-jack.de";
            const subject = encodeURIComponent(`Beitrittserkl√§rung KJN - ${formData.get('vorname')} ${formData.get('name')}`);
            const body = encodeURIComponent(`Hallo KJN-Team,\n\nanbei sende ich meine Beitrittserkl√§rung als PDF.\n\nViele Gr√º√üe\n${formData.get('vorname')}`);
            window.location.href = `mailto:${mail}?subject=${subject}&body=${body}`;
        });

        
function closeModal(event) {
    // Verhindert, dass ein Button-Klick das Formular abschickt oder die Seite neu l√§dt
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const modal = document.getElementById('choice-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}
     
    </script>
</body>
</html>





